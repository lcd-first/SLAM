# 多传感器定位

# 日志

- 5月8号    4节课 



# 资料： 

```
github 作业分享 
https://github.com/zhouyong1234/Multi-Sensor-Fusion
https://github.com/kahowang/sensor-fusion-for-localization-and-mapping/tree/main

csdn 作业分享
https://blog.csdn.net/hitljy/article/details/109227799?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522171517310016800184168083%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=171517310016800184168083&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-109227799-null-null.142^v100^pc_search_result_base4&utm_term=%E5%A4%9A%E4%BC%A0%E6%84%9F%E5%99%A8%E8%9E%8D%E5%90%88%E5%AE%9A%E4%BD%8D%E4%BD%9C%E4%B8%9A&spm=1018.2226.3001.4449

课程讲师，知乎教程
https://zhuanlan.zhihu.com/c_1114864226103037952
以及配套github代码
https://github.com/Little-Potato-1990/localization_in_auto_driving
```



![image-20240508175513190](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240508175513190.png)



# 1. 3D激光里程计



## 1. 激光传感器原理





## 2. 整理流程介绍

![image-20240508180118984](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240508180118984.png)















## 3. 前端里程计方案

- 对前端要求不高，但要求有足够的平滑性

![image-20240508180524147](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240508180524147.png)

### 1. 前端里程计-直接匹配

#### 1. ICP- 点到点

![image-20240508181044834](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240508181044834.png)



- 怎样让两段点云重合

- 以及如何评价两端点云的重合情况  

  - 所有点都是重合的 - 最理想
  - 过滤一下 用两段点云中都存在的点为对应点进行匹配  采样  随机采样  平均采样  
  - 是否匹配的好，就是点与点之间的距离 距离越近 匹配越好

- 求对应点 关联  迭代

  - 求两端点云A，B， 求A 点云中一个点，和B点云中某点距离最短的一个点，注意：最近点不一定是想要的点，所以才进行迭代
  - 求解位姿，将新的位姿加进去，在求解一次最近点，得到位姿，再加进去，直到两个点云完全重合

- icp 缺点

  - 在计算关联点时，通过得出的位姿，计算下一次关联点时，计算的新的关联点可能比上一次的关联点还不准，关联点的距离还会更远

  - 需要准确的初始位姿

![image-20240508184521299](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240508184521299.png)

#### 2. NDT 

![image-20240508184722344](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240508184722344.png)



优点

- 鲁棒性更强
- 计算量小

思想

- 将A点云划分为栅格 ，每个栅格中有很多点 ，这些点会有一种分布 均值  方差 
- B点云也有一个分布，不划分栅格 ，A和B 都有一个初始位姿，将B点云 通过旋转平移到A点云，B点云会落到A的栅格里
- 若A点云和B点云的在A的栅格中的分布相同或接近，则认为匹配成功



![image-20240508203743623](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240508203743623.png)



![image-20240508204330028](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240508204330028.png)

![image-20240508204439332](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240508204439332.png)







![image-20240508204711423](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240508204711423.png)



### 2. 前端里程计方案-基于特征



![image-20240508211403128](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240508211403128.png)



- 精度 和 效率 高

工作思路：

- 提取特征
  - 按线数分割
  - 计算曲率
  - 删除异常点
  - 按照曲率大小筛选特征点
    - 曲率特别大的点 sharp
    - 曲率大的点 lsee_shap
    - 曲率特别小的点  flat
    - 曲率小的点 less_flat
- 帧间匹配
  - 特征关联与损失函数计算
    - 线特征
    - 面特征
  - LM迭代优化
- 构建地图
  - 合并地图点
    - 把关键帧的特征点按照位姿转到地图坐标系中
    - 按照位置和cube尺寸划分到对应的cube中
  - 位姿优化与里程计的方法同理

- ALOAM 主要特点
  - 取消了和imu相关的部分
  - 使用eigen库 做位姿变换，简化了代码
  - 使用ceres 库做迭代优化，简化了代码，但降低了效率
- FLOAM
  - 整体和ALOAM类似，只是把ceres中的自动求导，转变成了直接使用推导的雅可比矩阵 
- LEGO-LOAM
  - 主要特点
    - 对地面做了分割，减小了特征搜索范围
    - 提取特征之前做了聚类，提高了特征质量
    - 水平和航向分别优化，提高了效率
  - 特征提取
    - 根据线与线之间的夹角，以及点的曲率，筛选出地面点，所有用于匹配的平面点仅使用地面点
    - 在非地面点中，使用广度优先搜索（BFS）做聚类，聚类中点的数量大于30，才用来筛选线特征
    - 筛选线特征方法，与LOAM中相同
  - 里程计
    - 使用地面面特征优化高度和水平角
    - 使用线特征优化水平位移和航线角
    - 具体推导过程，可根据LOAM 中的六自由度方法，重新推导此处三自由度方法 





## 4. 基于数据集实现

### 1. KITTI 数据集简介

硬件组成

1. 一个64线激光雷达， 在车顶的正中心
2. 两个彩色摄像头和两个黑白摄像头，在雷达两侧
3. 一个组合导航系统（OXTS RT 3003），在雷达左后方，它可以输出RTK/IMU组合导航结果，包括经纬度和姿态，同时也输出IMU原始数据

![image-20240508220611444](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240508220611444.png)



安装关系，在标定文件中可以找到



![image-20240508220643724](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240508220643724.png)





### 2. 数据集的使用



![image-20240508220748574](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240508220748574.png)

![image-20240508220842944](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240508220842944.png)





### 3. 里程计工程框架实现

核心思想：

1. 通过类封装，实现模块化
2. 把ros流程和C++ 内部分开，使流程清晰
3. 基于c++ 多态，实现高可扩展性

![image-20240508221714129](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240508221714129.png)

具体参考讲师知乎专栏



### 4. 里程计精度评价

以组合惯导的结果为真值，使用evo工具进行里程计精度评价

![image-20240508222027326](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240508222027326.png)







# 2. 点云地图构建基于地图的定位



## 1. 回环检测



![image-20240512205917229](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240512205917229.png)





![image-20240513122531748](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240513122531748.png)



1. 点云切割
2. 生成 scan context 
3. 基于scan context 的匹配
4. 计算相对位姿
5. 解决时间复杂度









## 2. 后端优化

### 1. 概念

目的： 利用回环检测结果和惯导先验位姿修正里程计误差，回环在此处提供的是两帧之间的相对位姿

观测： 

1. 连续两帧的相对位姿观测
2. 闭环匹配得到相对位姿观测
3. 组合导航提供的先验位姿观测

1 和 2 的观测 构成了基于回环的位姿修正

1和 3 的观测构成了基于先验观测的位姿修正

 1 2  3 可以同时使用

### 2. 李群，李代数

![image-20240513131831541](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240513131831541.png)





![image-20240513131911836](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240513131911836.png)





![image-20240513131942835](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240513131942835.png)





![image-20240513132227456](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240513132227456.png)



![image-20240513132241438](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240513132241438.png)



![image-20240513132356349](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240513132356349.png)





### 3. 基于回环的位姿修正

 位姿图优化是把所有的观测和状态放在一起优化，残差项是前面所讲残差项的总和，在实际使用中，各残差会被分配一个权重，也就是信息矩阵，它相当于

对残差进行加权

![image-20240513132856042](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240513132856042.png)



![image-20240513132925543](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240513132925543.png)



![image-20240513133105631](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240513133105631.png)

 ![image-20240513133534328](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240513133534328.png)



![image-20240513133614639](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240513133614639.png)







### 4. 基于先验观测的位姿修正

先验观测是一元边，它不像前面所描述的帧间观测连接两个位姿状态，而是只连接一个位姿的状态量，它直接给出的就是该状态量的观测值，因此它对应的残差就是观测值与状态量之间的差异



![image-20240513133949358](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240513133949358.png)



## 3. 点云地图的建立

### 1. 建图流程

建图流程设计核心原则是准确，高效的把里程计相对位姿，回环相对位姿，惯导先验位姿进行融合。

![image-20240513135441671](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240513135441671.png)





### 2. 畸变补偿

1. 产生原因：

   一帧点云中的激光点是不同时刻采集的，激光点的坐标原点是采集时刻的雷达位姿，雷达在不同时刻的位姿有变化时，各激光点

   原点不一致，拼接成一帧时，点云的形状便和实际物体形状不一致

2. 补偿方法：

   对每个激光点坐标进行补偿，补偿量为激光点原点（雷达坐标) 相对于该帧起始时刻的变换

3. 补偿公式：

**![image-20240513140322913](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240513140322913.png)**







### 3. 建图流程代码

基于g2o的代码实现





## 4. 基于地图的定位



### 1. 整体流程

在地图匹配中，鲁棒性和运行速度更加中央和，因此才使用中，基于NDT的匹配使用更广泛



![image-20240513141030688](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240513141030688.png)





### 2. 位姿初始化

由于NDT匹配需要较准确的初始位姿，因此在定位之前需要初始化环境，给出载体的初始位姿

按照难度由到高，常见的初始化需求有

1. 已知位姿的初始化
2. 位置已知而姿态未知的初始化
3. 位置和姿图均未知的初始化







![image-20240513141635076](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240513141635076.png)











#  3. 惯性导航基础



## 1. 技术简介



## 2. 惯性器件误差分析

### 1. 信号误差组成

1. 量化噪声
2. 角度随机游走
3. 角速率随机游走
4. 零偏不稳定噪声
5. 速率斜坡
6. 零偏重复性

### 2. Allan 方差分析

![image-20240513154509756](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240513154509756.png)

![image-20240513155205520](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240513155205520.png)





## 3. 惯性器件内参标定

### 1. 惯性器件内参误差模型

1. 零偏

   误差解释： 陀螺仪或加速度计输出中的常值偏移，常说的bias

   误差特性：由于零偏存在不稳定性，因此零偏并不是固定不变的

   解决办法： 实际使用中只能一段时间内近似为常值

2. 刻度系数误差

   误差解释： 器件的输出往往为脉冲或者模数转换得到的值，需要乘以一个刻度系数才能转换成角度或者加速度值，若该系数不准，便存在刻度系数误差

   误差特性： 不一定是常值，它会随着输入的大小的不同而变化，这个就是标度因数的非线性

   解决办法： 如果非线性程度比较大， 则需要在标定之前先拟合该非线性曲线，并补偿成线性再做标定

![image-20240513160559948](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240513160559948.png)

3. 安装误差

![image-20240513160625554](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240513160625554.png)







![image-20240513161059983](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240513161059983.png)



### 2. 内参误差标定



#### 1. 标定方法概述

标定的本质是 参数辨识，参数包括陀螺仪和加速度计各自的零偏，刻度系数误差，安装误差

辨识方法：

1. 解析法或最小二乘
2. 梯度下降迭代优化
3. 滤波

标定方法：

1. 分立级标定：解析法，最小二乘
2. 半系统级标定：梯度下降迭代优化
3. 系统级标定：卡尔曼滤波，最小二乘



#### 2.分立级标定

在IMU的误差模型中，陀螺仪和加速度计的误差方程式是互相独立的，可分别标定

![image-20240513162134439](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240513162134439.png)





![image-20240513162305411](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240513162305411.png)





![image-20240513162448063](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240513162448063.png)



![image-20240513200851583](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240513200851583.png)

  



![image-20240513202917413](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240513202917413.png)

 





![image-20240513204513713](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240513204513713.png)





#### 3. 半系统级标定

1. 整体思路

   脱离转台，从天然的真值（重力加速度）中去寻找约束

2. 主要包括

   1. 加速度测到的重力大小与真实重力之间的差异由加速度内参误差引起的，以它的残差，以它为残差，可以估计加速度计的内参
   2. 陀螺仪计算得到的姿态与真实姿态之间的差异由陀螺仪内参误差引起的，但真实姿态并不存在，因此根据姿态投影得到的重力矢量与真实重力矢量之间的差异计算残差，去估计陀螺仪内参















 















## 4. 惯性器件温度补偿

温补的本质是系统辨识，既要找到合适的物理模型，又要识别物理模型的参数。

![image-20240513212443660](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240513212443660.png)





![image-20240513213234903](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240513213234903.png)

 



 

























## 5. 惯性导航解算







## 6. 惯性导航误差分析







# 4. 基于滤波器的融合



## 1. 滤波器的作用

滤波器的本质： 结合预测和观测，得到最精确的后验值

实际中，预测与观测都从传感器来，因此滤波器的作用便是结合各传感器得到一个最好的融合效果

1. 实际中预测往往从IMU，编码器等传感器递推而来
2. 观测 从 GPS ，雷达，相机 来
3. 后验 为融合后的结果，即定位模块的输出





## 2. 滤波基础知识

1. 概率，概率密度

概率密度： 随机变量区间内的分布情况

高斯分布，非高斯分布都是概率密度

2. 联合概率

![image-20240517113429139](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240517113429139.png)

![](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240517113526487.png)

![image-20240517113703882](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240517113703882.png)



![image-20240517113748848](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240517113748848.png)



![image-20240517113959033](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240517113959033.png)

![image-20240517114124072](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240517114124072.png)













## 3. 滤波器基本原理 

### 1.状态估计模型

![image-20240517205410571](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240517205410571.png)



### 2. 贝叶斯滤波







## 4. 基于滤波器的融合

滤波器问题可以理解为： 预测 + 观测 = 融合结果

结合实际点云地图中定位的例子，预测IMU 给出，观测即为激光雷达点云和地图匹配得到的姿态和位置

![image-20240518121311859](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240518121311859.png)



### 1. 基于误差状态的滤波



![image-20240518122513817](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240518122513817.png)





![image-20240518122620097](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240518122620097.png)









 ![image-20240518123337392](D:\SLAM\多传感器融合定位课程学习\多传感器定位笔记.assets\image-20240518123337392.png)



















## 5. 观测性与观测度分析



 

















